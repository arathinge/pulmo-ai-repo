<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - PULMO AI</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <a href="main.html" class="logo-principal"><img src="Pulmo.png" alt="Logo PULMO AI"></a>
            <nav>
                <ul>
                    <li><a href="main.html">Inicio</a></li>
                    <li><a href="sec.html">Diagn√≥stico</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <section class="main-content">
            
            <h2 id="welcome-message" style="text-align: left; margin-top: 15px;"></h2>
            <h2>Diagn√≥stico de Hipertensi√≥n Pulmonar</h2>
            <p>Introduzca los 5 par√°metros del paciente para que el modelo de IA genere un diagn√≥stico.</p>
            
            <div class="patient-info" style="margin-bottom: 20px; padding: 10px; background-color: #f4f4f4; border-radius: 5px;">
                <p style="margin: 0;"><strong>Paciente:</strong> C√©sar Mej√≠a</p>
            </div>

            <form id="ia-form"> 
                
                <div class="form-group">
                    <label for="causa_seleccionada">1. Comorbilidad asociada:</label>
                    <select id="causa_seleccionada" name="causa_seleccionada" required>
                        <option value="none">Ninguna</option>
                        <option value="cardiopatias_congenitas">Cardiopat√≠as cong√©nitas</option>
                        <option value="evop_hcp">HAP con caracter√≠sticas de afectaci√≥n venosa o capilar (EVOP/HCP)</option>
                        <option value="enf_tejido_conectivo">Enfermedad del tejido conectivo</option>
                        <option value="infeccion_vih">Infecci√≥n por VIH</option>
                        <option value="colangitis_biliar">Colangitis biliar primaria</option>
                        <option value="idiopatica">Idiop√°tica</option>
                        <option value="asociada_drogas_toxinas">Asociada a drogas y toxinas</option>
                        <option value="hereditaria">Hereditaria</option>
                        <option value="esquistosomiasis">Esquistosomiasis</option>
                        <option value="hipertension_portal">Hipertensi√≥n portal</option>
                        <option value="hp_neonato">HP persistente del neonato</option>
                        <option value="en_estudio">En estudio</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fatiga">2. ¬øEl paciente presenta fatiga?</label>
                    <select id="fatiga" name="fatiga" required>
                        <option value="0">No</option>
                        <option value="1">S√≠</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bendopnea">3. ¬øEl paciente presenta dificultad para respirar durante flexi√≥n anterior del tronco (bendopnea)?</label>
                    <select id="bendopnea" name="bendopnea" required>
                        <option value="0">No</option>
                        <option value="1">S√≠</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="hemoptisis">4. ¬øEl paciente presenta expectoraci√≥n de sangre al toser (hemoptisis)?</label>
                    <select id="hemoptisis" name="hemoptisis" required>
                        <option value="0">No</option>
                        <option value="1">S√≠</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="sincope">5. ¬øEl paciente presenta p√©rdida temporal y/o s√∫bita de la conciencia durante o poco despu√©s del esfuerzo f√≠sico (s√≠ncope)</label>
                    <select id="sincope" name="sincope" required>
                        <option value="0">No</option>
                        <option value="1">S√≠</option>
                    </select>
                </div>
                
                <button type="submit" class="btn-primary">Generar diagn√≥stico</button>
            </form>


            <hr>

            <h3>Resultado del Modelo</h3>
            <div id="forecast-result">
                El pron√≥stico aparecer√° aqu√≠.
            </div>
            
            <div class="warning-section" style="margin-top: 20px;">
                <p>üö® **ADVERTENCIA PROFESIONAL:** Este resultado es una **clasificaci√≥n de Sospecha de HP** generada por un modelo de Inteligencia Artificial, **NO ES UN DIAGN√ìSTICO**. La interpretaci√≥n de esta informaci√≥n es responsabilidad exclusiva del profesional de la salud.</p>
            </div>
        </section>
    </div>

    <footer>
        <div class="container">
            <p>Con el respaldo de:</p>
            <div class="logos-institucionales">
                <img src="UAQ.png" alt="Logo Instituci√≥n 1" id="logo-inst-1">
                <img src="SJR.png" alt="Logo Instituci√≥n 3" id="logo-inst-4">
                <img src="INER.png" alt="Logo Instituci√≥n 2" id="logo-inst-2">
                <img src="FOPER.png" alt="Logo Instituci√≥n 3" id="logo-inst-3">
                </div>
        </div>
    </footer>

    <script>
        // Manejador para el saludo inicial
        window.onload = function() {
            const doctorName = prompt("Por favor, ingrese su nombre, Dr.: ");

            if (doctorName && doctorName.trim() !== "") {
                document.getElementById('welcome-message').innerHTML = `Bienvenido, Dr. ${doctorName}`;
            } else {
                document.getElementById('welcome-message').innerHTML = 'Bienvenido, Doctor';
            }
        };

        // Manejador del formulario para prevenir el env√≠o y llamar a la funci√≥n
        document.getElementById('ia-form').addEventListener('submit', function(event) {
            event.preventDefault();
            generateForecast();
        });


        async function generateForecast() {
            // üö®üö®üö® CORRECCI√ìN CRUCIAL: URL REAL DE RENDER üö®üö®üö®
            const API_URL = "https://pulmo-ai-repo.onrender.com"; 

            const resultDiv = document.getElementById('forecast-result');
            resultDiv.innerHTML = "Procesando...";
            resultDiv.className = ''; 

            try {
                // 1. Obtener los 5 valores del formulario
                const fatigaVal = document.getElementById('fatiga').value;
                const bendopneaVal = document.getElementById('bendopnea').value;
                const hemoptisisVal = document.getElementById('hemoptisis').value;
                const sincopeVal = document.getElementById('sincope').value;
                const causaSeleccionada = document.getElementById('causa_seleccionada').value; 
                
                // 2. Crear el JSON para enviar al backend.
                // *CORRECCI√ìN*: S√≥lo enviamos los 5 campos que el backend espera
                const dataToSend = {
                    fatiga: parseInt(fatigaVal),
                    bendopnea: parseInt(bendopneaVal),
                    hemoptisis: parseInt(hemoptisisVal),
                    sincope: parseInt(sincopeVal),
                    causa_seleccionada: causaSeleccionada // FastAPI mapear√° esto a causa_g1
                };
                
                // 3. Enviar al backend
                const response = await fetch(`${API_URL}/predict`, { // Usa la API_URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend),
                });

                const result = await response.json();

                // 4. Mostrar el resultado (Clasificaci√≥n Binaria)
                if (response.ok && result.success) { 
                    const diagnosis = result.diagnosis; 

                    let riskClass = '';
                    if (diagnosis === "Sospecha de HP") {
                        riskClass = 'result-high-risk'; 
                    } else { 
                        riskClass = 'result-low-risk'; 
                    }
                    
                    resultDiv.className = riskClass;

                    // *** CORRECCI√ìN SOLICITADA: Quitamos la palabra "Clasificaci√≥n" ***
                    resultDiv.innerHTML = `
                        <strong>${diagnosis}</strong>
                    `;
                    // ***************************************************************
                } else {
                    let errorDetail = result.detail || 'Error desconocido';
                    if (Array.isArray(result.detail)) {
                        // Formatear errores de validaci√≥n de FastAPI
                        errorDetail = result.detail.map(e => `${e.loc[1]}: ${e.msg}`).join('<br>');
                    }
                    resultDiv.innerHTML = `Error en la predicci√≥n: <br>${errorDetail}`;
                    resultDiv.className = 'result-error';
                }

            } catch (error) {
                console.error('Error en fetch:', error);
                // Mensaje de error m√°s claro para el usuario final
                resultDiv.innerHTML = "‚ùå Error de conexi√≥n. No se pudo contactar al servidor de IA. Por favor, aseg√∫rese de que el servicio en Render est√© activo.";
                resultDiv.className = 'result-error';
            }
        }
    </script>
</body>
</html>
